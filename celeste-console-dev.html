<script>
const log   = document.getElementById("log");
const input = document.getElementById("input");
const consoleBox = document.querySelector(".console");

let guidanceShown = false;

function addEntry(text, cls){
  const div = document.createElement("div");
  div.className = "entry " + cls;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function showGuidanceOnce(text){
  if (guidanceShown) return;
  guidanceShown = true;

  const g = document.createElement("div");
  g.textContent = text;
  g.style.position = "absolute";
  g.style.top = "50%";
  g.style.left = "50%";
  g.style.transform = "translate(-50%, -50%)";
  g.style.color = "var(--muted)";
  g.style.opacity = "0.9";
  g.style.transition = "opacity 2s ease";
  g.style.pointerEvents = "none";

  consoleBox.appendChild(g);

  setTimeout(() => g.style.opacity = "0", 1200);
  setTimeout(() => g.remove(), 3200);
}

function pulseBorder(){
  consoleBox.style.borderColor = "#6b7cff";
  setTimeout(() => {
    consoleBox.style.borderColor = "rgba(70,84,132,0.65)";
  }, 900);
}

function send(){
  const value = input.value.trim();
  if(!value) return;

  showGuidanceOnce("ここに自由に書けます。");
  pulseBorder();

  addEntry(value, "user");
  input.value = "";
  input.style.height = "auto";

  fetch("/api/celeste-dev", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message:value })
  })
  .then(res => res.json())
  .then(data => {
    if (data.reply && data.reply.trim() !== "") {
      addEntry(data.reply, "celeste");
    }
  })
  .catch(()=>{});
}

input.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

input.addEventListener("input", () => {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});
</script>
