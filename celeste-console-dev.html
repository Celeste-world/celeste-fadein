<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Celeste Console – Dev</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg: #050811;
  --panel: rgba(255,255,255,0.05);
  --border: rgba(255,255,255,0.18);
  --text: #e8ebef;
  --dim: rgba(232,235,239,0.55);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  background:
    radial-gradient(1200px 600px at 50% -200px, #0d1633, transparent),
    var(--bg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
}

.console {
  width: min(720px, 92vw);
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 28px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.55);
  transition: border-color .3s, box-shadow .3s;
}

.console.pressure-1 { border-color: rgba(180,200,255,.35); }
.console.pressure-2 { border-color: rgba(140,180,255,.55); box-shadow: 0 0 0 1px rgba(140,180,255,.15), 0 40px 80px rgba(0,0,0,.55); }
.console.pressure-3 { border-color: rgba(255,190,160,.55); box-shadow: 0 0 0 1px rgba(255,190,160,.18), 0 40px 80px rgba(0,0,0,.55); }

.log {
  min-height: 140px;
  white-space: pre-wrap;
  line-height: 1.65;
  font-size: 15px;
}

.log .user { color: #cfe0ff; }
.log .celeste { color: #ffffff; }
.log .notice { color: var(--dim); font-size: 13px; margin-top: 8px; }

.input-wrap {
  margin-top: 18px;
  border-top: 1px solid rgba(255,255,255,.12);
  padding-top: 14px;
}

input {
  width: 100%;
  background: transparent;
  border: 1px solid rgba(255,255,255,.2);
  border-radius: 12px;
  padding: 12px 14px;
  color: var(--text);
  font-size: 15px;
  outline: none;
}

input::placeholder {
  color: rgba(232,235,239,.45);
}

.footer {
  margin-top: 10px;
  text-align: right;
  font-size: 11px;
  color: rgba(232,235,239,.35);
}
</style>
</head>

<body>

<div id="console" class="console">
  <div id="log" class="log"></div>

  <div id="notice" class="log notice" style="display:none;"></div>

  <div class="input-wrap">
    <input
      id="input"
      placeholder="Write freely."
      autocomplete="off"
    />
  </div>

  <div class="footer">CELESTE v4.4-dev</div>
</div>

<script>
const API_URL = "/functions/api/celeste-dev";
const log = document.getElementById("log");
const notice = document.getElementById("notice");
const input = document.getElementById("input");
const consoleBox = document.getElementById("console");

function setPressure(p) {
  consoleBox.className = "console";
  if (p > 0) consoleBox.classList.add("pressure-" + p);
}

function addLine(text, cls) {
  const div = document.createElement("div");
  div.className = cls;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function showNotice(text) {
  notice.textContent = text;
  notice.style.display = text ? "block" : "none";
}

async function sendMessage(text) {
  addLine(text, "user");

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    const contentType = res.headers.get("content-type") || "";
    if (!contentType.includes("application/json")) {
      throw new Error("Non-JSON response");
    }

    const data = await res.json();

    if (data.reply) {
      addLine(data.reply, "celeste");
    }

    setPressure(data.pressure || 0);

    if (data.pressure === 2) {
      showNotice("このあたりは、まだ書き続けられます。");
    } else if (data.pressure === 3) {
      showNotice("ここで一度、区切ってもよさそうです。");
    } else {
      showNotice("");
    }

  } catch (e) {
    addLine("[API error]", "celeste");
    setPressure(0);
    showNotice("");
  }
}

input.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    sendMessage(text);
  }
});
</script>

</body>
</html>
