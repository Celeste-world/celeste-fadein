<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Celeste Console – Dev</title>

<link rel="icon" href="/images/favicon.svg" type="image/svg+xml">

<style>
:root{
  /* 深い夜（ベース） */
  --bg-base: #050811;

  /* セレステブルー（層の色：固定） */
  --celeste-blue-1: rgba(120, 150, 255, 0.22);
  --celeste-blue-2: rgba(120, 150, 255, 0.10);
  --celeste-blue-3: rgba(120, 150, 255, 0.00);

  /* 気流レイヤーの状態（JSでゆっくり変える） */
  --drift-x: -6%;
  --drift-y: -4%;
  --drift-rot: -6deg;
  --drift-scale: 1.12;
  --drift-opacity: 0.28;

  --panel:#111623;
  --panel-border:#465484;
  --panel-border-react:#4e49c8;

  --text:#e8ebef;
  --muted:#a0a8bb;
  --line:#252b3a;
  --accent:#a9b7ff;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  background: var(--bg-base);
  color:var(--text);
  font-family: ui-serif, Georgia, "Times New Roman", serif;
  overflow-x:hidden;
  position:relative;
}

/* =========================
   v5.0A – Celeste Blue Drift Layer
   ========================= */
body::before{
  content:"";
  position:fixed;
  inset:-18%;
  pointer-events:none;
  z-index:0;

  /* 横断する気流：斜め方向の大きなグラデーション */
  background:
    linear-gradient(
      115deg,
      var(--celeste-blue-3) 0%,
      var(--celeste-blue-2) 28%,
      var(--celeste-blue-1) 52%,
      var(--celeste-blue-2) 74%,
      var(--celeste-blue-3) 100%
    ),
    radial-gradient(
      800px 520px at 22% 38%,
      rgba(155, 188, 255, 0.10),
      rgba(155, 188, 255, 0.00) 60%
    );

  opacity: var(--drift-opacity);

  transform:
    translate(var(--drift-x), var(--drift-y))
    rotate(var(--drift-rot))
    scale(var(--drift-scale));

  filter: blur(18px);
  transition:
    transform 28s ease-in-out,
    opacity 28s ease-in-out;
}

/* コンテンツをレイヤーの上へ */
.wrap{
  position:relative;
  z-index:1;
  max-width:960px;
  margin:0 auto;
  padding:48px 20px 40px;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* Intro */
.intro{
  margin-bottom:24px;
  color:var(--muted);
  font-size:15px;
  line-height:1.8;
}

/* Console */
.console{
  background:rgba(10,14,28,0.90);
  border:1px solid var(--panel-border);
  border-radius:16px;
  padding:22px 20px 24px;
  box-shadow:0 18px 38px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
  transition: border-color 0.6s ease;
}

.console.receptive{
  border-color: var(--panel-border-react);
}

.log{
  min-height:280px;
  max-height:520px;
  overflow-y:auto;
  padding-right:6px;
}

.entry{
  margin:14px 0;
  line-height:1.9;
  white-space:pre-wrap;
}

.entry.user{
  color:var(--accent);
}

.entry.celeste{
  color:var(--text);
}

.divider{
  border-top:1px solid var(--line);
  margin:32px 0 16px;
}

textarea{
  width:100%;
  background:transparent;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  color:var(--text);
  resize:none;
  font-family:inherit;
  font-size:15px;
  min-height:48px;
}

textarea::placeholder{
  color:#6d7588;
}

footer{
  margin-top:32px;
  padding-top:18px;
  border-top:1px solid rgba(37,43,58,0.9);
  font-size:12px;
  color:var(--muted);
  display:flex;
  justify-content:flex-end;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="intro">
    A quiet space to organize your thoughts — decisions stay with you.<br>
    This space is open to whatever you choose to write.<br>
    <a href="/faq.html">You can read the FAQ anytime.</a>
  </div>

  <div id="console" class="console">
    <div id="log" class="log"></div>
    <div class="divider"></div>
    <textarea id="input" rows="1" placeholder="Write freely."></textarea>
  </div>

  <footer>
    <span>CELESTE v5.0A-dev</span>
  </footer>

</div>

<script>
const log        = document.getElementById("log");
const input      = document.getElementById("input");
const consoleEl  = document.getElementById("console");
const rootStyle  = document.documentElement.style;

/* session */
let sessionId = localStorage.getItem("celeste.sessionId");
if (!sessionId) {
  sessionId = crypto.randomUUID();
  localStorage.setItem("celeste.sessionId", sessionId);
}

function addEntry(text, cls){
  const div = document.createElement("div");
  div.className = "entry " + cls;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* 枠：受容（遅延） */
function receptivePulse(){
  setTimeout(() => {
    consoleEl.classList.add("receptive");
    setTimeout(() => consoleEl.classList.remove("receptive"), 600);
  }, 400);
}

/* =========================
   v5.0A – Celeste Blue Drift (A2: slightly irregular)
   - 色は固定（セレステブルー）
   - 位置 / 回転 / 濃度 / 微拡大で「気流」を作る
   ========================= */

function rand(min, max){ return min + Math.random() * (max - min); }

let driftPhase = 0;

function setDriftTarget(){
  driftPhase++;

  // ごく弱い不規則性：毎回少しだけ違う
  const x = rand(-10, 10);     // %
  const y = rand(-8, 8);       // %
  const rot = rand(-10, 10);   // deg
  const scale = rand(1.08, 1.18);
  const opacity = rand(0.20, 0.34);

  rootStyle.setProperty("--drift-x", x.toFixed(2) + "%");
  rootStyle.setProperty("--drift-y", y.toFixed(2) + "%");
  rootStyle.setProperty("--drift-rot", rot.toFixed(2) + "deg");
  rootStyle.setProperty("--drift-scale", scale.toFixed(3));
  rootStyle.setProperty("--drift-opacity", opacity.toFixed(3));

  // 周期：40〜70秒（微不規則）
  const next = rand(40000, 70000);

  // 変化速度も少し揺らす（過剰にしない）
  const t = rand(24, 34); // seconds
  document.body.style.setProperty("--drift-t", t.toFixed(1) + "s");

  setTimeout(setDriftTarget, next);
}

/* 開始：いきなり動かさず、少し置く */
setTimeout(setDriftTarget, 5000);

/* Send */
function send(){
  const value = input.value.trim();
  if(!value) return;

  addEntry(value, "user");
  input.value = "";
  input.style.height = "auto";

  receptivePulse();

  fetch("/api/celeste", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message:value, sessionId })
  })
  .then(res => res.json())
  .then(data => {
    // 沈黙は表示しない（現行仕様）
    if (data.reply && data.reply.trim() !== "") {
      addEntry(data.reply, "celeste");
    }
  })
  .catch(()=>{});
}

/* Enter to send */
input.addEventListener("keydown", e => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

/* Auto resize */
input.addEventListener("input", () => {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
});
</script>

</body>
</html>
