<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Celeste Console – Dev</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root {
  --bg: #050811;
  --panel: #0b1020;
  --border: rgba(160,180,255,0.18);
  --border-active: rgba(160,180,255,0.45);
  --text: #e8ebef;
  --muted: #8a90a8;
  --accent: #9bb1ff;
}

html, body {
  margin: 0;
  padding: 0;
  background: radial-gradient(1200px 600px at 50% 10%, #0b1230, #050811);
  color: var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

.wrapper {
  max-width: 820px;
  margin: 60px auto;
  padding: 0 20px;
}

.console {
  background: linear-gradient(180deg, #0b1020, #070b18);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 28px 26px 22px;
  transition: border-color 0.35s ease;
}

.console.active {
  border-color: var(--border-active);
}

.output {
  min-height: 140px;
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 15px;
}

.output .user {
  color: var(--accent);
}

.output .reply {
  margin-top: 10px;
}

.input-wrap {
  margin-top: 22px;
}

textarea {
  width: 100%;
  resize: none;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: border-color 0.3s ease;
}

textarea:focus {
  border-color: var(--border-active);
}

.notice {
  position: fixed;
  left: 50%;
  bottom: 22%;
  transform: translateX(-50%);
  color: var(--muted);
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

.notice.show {
  opacity: 1;
}

.footer {
  margin-top: 12px;
  text-align: right;
  font-size: 11px;
  color: #6c738f;
}
</style>
</head>

<body>
<div class="wrapper">

  <div id="console" class="console">
    <div id="output" class="output"></div>

    <div class="input-wrap">
      <textarea id="input" rows="2" placeholder="Write freely."></textarea>
    </div>
  </div>

  <div id="notice" class="notice">
    This space is open to whatever you choose to write.
  </div>

  <div class="footer">CELESTE v4.4-dev</div>

</div>

<script>
const input = document.getElementById("input");
const output = document.getElementById("output");
const notice = document.getElementById("notice");
const consoleBox = document.getElementById("console");

let busy = false;

input.addEventListener("keydown", async (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    if (busy) return;

    const text = input.value.trim();
    if (!text) return;

    input.value = "";
    busy = true;

    output.innerHTML += `<div class="user">${escapeHtml(text)}</div>\n`;

    try {
      const res = await fetch("/functions/api/celeste-dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      const data = await res.json();
      const reply = data.reply || "";
      const pressure = data.pressure || 0;

      applyPressureUI(pressure);

      if (reply) {
        output.innerHTML += `<div class="reply">${escapeHtml(reply)}</div>\n`;
      }

    } catch (err) {
      console.error(err);
    }

    busy = false;
  }
});

function applyPressureUI(pressure) {
  // 枠反応
  if (pressure >= 1) {
    consoleBox.classList.add("active");
  } else {
    consoleBox.classList.remove("active");
  }

  // 注意書き
  if (pressure >= 1) {
    notice.classList.add("show");
  } else {
    notice.classList.remove("show");
  }
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}
</script>
</body>
</html>
