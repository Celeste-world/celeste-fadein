<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Celeste – Console</title>

<link rel="icon" href="/images/favicon.svg" type="image/svg+xml">

<style>
:root{
  --bg:#050811;
  --text:#e8ebef;
  --accent:#9bbcff;
  --panel:rgba(10,14,28,.72);
  --panel2:rgba(255,255,255,.03);
  --radius:18px;
  --shadow:0 24px 70px rgba(0,0,0,.52);
  --vh:100vh;
}
*{box-sizing:border-box;}

body{
  margin:0;
  height:var(--vh);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  background:
    radial-gradient(1200px 800px at 35% 20%, rgba(80,120,255,.2), transparent 55%),
    var(--bg);
  font-family:ui-serif, Georgia, "Times New Roman", serif;
  color:var(--text);
  padding:24px;
}

.wrap{width:min(760px,100%);}

.panel{
  background:linear-gradient(180deg,var(--panel2),rgba(255,255,255,.01));
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}

.log{
  padding:22px;
  max-height:62vh;
  overflow-y:auto;
  scrollbar-width:none;
}
.log::-webkit-scrollbar{display:none;}

.turn{margin-bottom:18px;}

.bubble{
  white-space:pre-wrap;
  line-height:1.65;
  font-size:16px;
}
.user{color:var(--accent);margin-bottom:8px;}
.assistant{color:var(--text);}

.intro{
  opacity:0;
  transition:opacity 1.8s ease;
}
.intro.visible{opacity:1;}
.intro.fadeout{
  opacity:0;
  transition:opacity 1.2s ease;
}

.inputbar{
  padding:14px 16px;
  border-top:1px solid rgba(255,255,255,.06);
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.22);
  color:var(--text);
  font-size:15px;
  outline:none;
}

.foot{
  padding:12px 16px;
  display:flex;
  justify-content:flex-end;
  gap:18px;
  font-size:12px;
}
.foot a{color:var(--accent);text-decoration:none;}
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div id="log" class="log"></div>
    <div class="inputbar">
      <input id="input" type="text" placeholder="Write freely." />
    </div>
    <div class="foot">
      <a href="/about.html">Back to About</a>
      <span>CELESTE v4.4A (dev)</span>
    </div>
  </div>
</div>

<script>
/*
  DEV IMPORTANT:
  Pages Functions を完全に回避して Worker を直叩きする。
  （これで pressure/response 旧API混入を強制的に断つ）
*/
const API = "https://celeste-api.celeste.world/api/celeste";

const logEl = document.getElementById("log");
const inputEl = document.getElementById("input");

let sessionLang = "";
let allowFocus = false;

// 会話履歴（user/assistant を交互に積む）
const history = [];
const HISTORY_LIMIT = 6; // worker は last 6 を採用している前提（user+assistant x3）

// iOS viewport fix
function setVH(){
  document.documentElement.style.setProperty("--vh", `${window.innerHeight}px`);
}
setVH();
window.addEventListener("resize", setVH);
window.addEventListener("orientationchange", setVH);

["mousedown","touchstart","keydown"].forEach(ev=>{
  window.addEventListener(ev,()=>{allowFocus=true;},{once:true});
});

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

function addTurn(text){
  const t=document.createElement("div");
  t.className="turn";

  const u=document.createElement("div");
  u.className="bubble user";
  u.textContent=text;

  const a=document.createElement("div");
  a.className="bubble assistant";
  a.textContent="...";

  t.append(u,a);
  logEl.appendChild(t);
  t.scrollIntoView({behavior:"smooth",block:"center"});
  return a;
}

// Intro
async function showIntro(){
  const i=document.createElement("div");
  i.className="bubble assistant intro";
  i.textContent="Hello, I’m Celeste.\n\nWrite freely.";
  logEl.appendChild(i);

  requestAnimationFrame(()=>i.classList.add("visible"));

  await sleep(3600);
  i.classList.add("fadeout");
  await sleep(1300);
  i.remove();

  if(allowFocus) inputEl.focus();
}
showIntro();

function pushHistory(role, content){
  history.push({ role, content });
  if(history.length > HISTORY_LIMIT){
    history.splice(0, history.length - HISTORY_LIMIT);
  }
}

async function send(){
  const msg=inputEl.value;
  if(!msg) return;
  inputEl.value="";
  const slot=addTurn(msg);

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        message: msg,
        lang: sessionLang,
        history: history
      })
    });

    const data=await res.json();

    // Worker 新API: { reply, lang }
    if(data.lang) sessionLang = data.lang;
    const reply = (data.reply || "").toString();

    slot.textContent = reply || "...";

    // 履歴に積む（UI表示したものだけを採用）
    pushHistory("user", msg);
    pushHistory("assistant", reply);

    slot.parentElement.scrollIntoView({behavior:"smooth",block:"center"});
  }catch(e){
    slot.textContent="...";
  }

  if(allowFocus) inputEl.focus();
}

inputEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    send();
  }
});
</script>
</body>
</html>
