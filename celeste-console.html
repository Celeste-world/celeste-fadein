<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Celeste – Console</title>

<link rel="icon" href="/images/favicon.svg" type="image/svg+xml" />

<style>
/* （CSSは前回提示と同一のため省略せずそのまま） */
:root{
  --bg:#050811;
  --panel:rgba(255,255,255,0.04);
  --text:#e8ebef;
  --muted:#a0a8bb;
  --user:#f0f2f8;
  --assistant:#9bbcff;
  --accent:#9bbcff;
  --accept: rgba(155,188,255,.78);
  --acceptShadow: rgba(155,188,255,.16);
}
*{box-sizing:border-box;}
html,body{
  margin:0;height:100%;
  background:radial-gradient(1200px 800px at 35% 20%, rgba(80,120,255,.18), transparent 55%),var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system;
}
.wrapper{min-height:100dvh;display:flex;justify-content:center;padding:env(safe-area-inset-top) 14px env(safe-area-inset-bottom);}
.console{
  width:100%;max-width:720px;margin:80px auto 60px;
  background:var(--panel);border-radius:18px;
  padding:24px 20px 18px;backdrop-filter:blur(14px);
}
.log{min-height:160px;max-height:56vh;overflow:auto;display:flex;flex-direction:column;}
.entry{
  white-space:pre-wrap;
  line-height:1.6;
  font-size:15px;
  margin:2px 0;
}
.entry.user{color:var(--user);}
.entry.assistant{color:var(--assistant);}
.input-wrap{margin-top:18px;}
input{
  width:100%;padding:14px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.22);color:var(--text);
}
input.accepting{animation:acceptBreath 1.7s ease forwards;}
@keyframes acceptBreath{
  0%{border-color:rgba(255,255,255,.14);}
  18%,65%{border-color:var(--accept);box-shadow:0 0 0 2px var(--acceptShadow);}
  100%{border-color:rgba(255,255,255,.14);box-shadow:none;}
}
.footer{
  margin-top:18px;padding-top:14px;border-top:1px solid rgba(37,43,58,.9);
  font-size:12px;color:var(--muted);display:flex;justify-content:flex-end;gap:16px;
}
.footer a{color:var(--muted);text-decoration:none;border-bottom:1px solid rgba(160,168,187,.35);}
</style>
</head>

<body>
<div class="wrapper">
  <div class="console">
    <div id="log" class="log"></div>

    <div class="input-wrap">
      <input id="input" placeholder="Write freely." autocomplete="off" disabled />
    </div>

    <div class="footer">
      <a href="/about.html">Back to About</a>
      <span>CELESTE v4.4A</span>
    </div>
  </div>
</div>

<script>
const API_ENDPOINT="/api/celeste";
const log=document.getElementById("log");
const input=document.getElementById("input");

function normalizeReply(text){
  if(!text) return "";
  return text
    .replace(/\r\n/g,"\n")
    .replace(/\n{2,}/g,"\n\n")
    .replace(/([^\n])\n([^\n])/g,"$1 $2");
}

function addEntry(text,cls){
  const e=document.createElement("div");
  e.className="entry "+cls;
  e.textContent=text;
  log.appendChild(e);
}

function playAcceptBreath(){
  input.classList.remove("accepting");
  void input.offsetWidth;
  input.classList.add("accepting");
  return new Promise(r=>input.addEventListener("animationend",r,{once:true}));
}

async function send(){
  const msg=input.value.trim();
  if(!msg) return;
  input.value="";
  const breath=playAcceptBreath();
  addEntry(msg,"user");
  await breath;

  try{
    const r=await fetch(API_ENDPOINT,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:msg})
    });
    const d=await r.json();
    const reply=normalizeReply(d.reply||"");
    if(reply) addEntry(reply,"assistant");
  }catch{}
  input.focus();
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter"){e.preventDefault();send();}
});

(function intro(){
  const e=document.createElement("div");
  e.className="entry assistant";
  e.textContent="Hello, I’m Celeste.\n\nWrite freely.";
  log.appendChild(e);
  setTimeout(()=>{e.style.opacity="0";},4000);
  setTimeout(()=>{e.remove();input.disabled=false;input.focus();},5400);
})();
</script>
</body>
</html>
